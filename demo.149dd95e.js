(function () {var t={};function v(i){let r=i.indexOf(" ");return[i.slice(0,r),i.slice(r+1)]}function O(i,r){if(i&&!r)return!1;if(!i&&r)return!0;if(i.time>r.time)return!1;if(i.time<r.time)return!0;let t=v(i.id),e=v(r.id);return!(t[1]>e[1])&&(t[1]<e[1]||!(t[0]>e[0])&&t[0]<e[0])}t={isFirstOlder:O};var P={};let{isFirstOlder:o}=t;function w(e,t){return e.lastAdded+=1,t[1].added=e.lastAdded,e.added.push(t),Promise.resolve(t[1])}function j(e,t){for(let d=e.length-1;d>=0;d--)if(t===e[d][1].id)return d;return-1}function k(e){return void 0!==e}class Q{constructor(){this.created=[],this.added=[],this.lastReceived=0,this.lastAdded=0,this.lastSent=0}async add(e,t){let d=[e,t],i=t.id,r=this.created;for(let s=0;s<r.length;s++){let[,e]=r[s];if(i===e.id)return!1;if(!o(e,t))return r.splice(s,0,d),w(this,d)}return r.push(d),w(this,d)}async byId(e){let t=j(this.created,e);if(-1===t)return[null,null];{let[e,d]=this.created[t];return[e,d]}}async remove(e,t){if(void 0===t&&-1===(t=j(this.created,e)))return Promise.resolve(!1);let d=[this.created[t][0],this.created[t][1]];this.created.splice(t,1);let i=d[1].added,r=0,s=this.added.length-1;for(;r<=s;){let e=s+r>>1,t=this.added[e][1].added;if(t<i)r=e+1;else{if(!(t>i)){this.added.splice(e,1);break}s=e-1}}return d}async get(e){let t;return{entries:(t="created"===e.order?this.created:this.added).slice(0)}}async changeMeta(e,t){let d=j(this.created,e);if(-1===d)return!1;{let e=this.created[d][1];for(let d in t)e[d]=t[d];return!0}}async removeReason(e,t,d){let i=[];if(t.id){let i=j(this.created,t.id);if(-1!==i){let r=this.created[i][1],s=r.reasons.indexOf(e);-1!==s&&(r.reasons.splice(s,1),0===r.reasons.length&&(d(this.created[i][0],r),this.remove(t.id)))}}else this.created=this.created.filter(([r,s])=>{let a=t,n=s.reasons.indexOf(e);return-1===n||!(!k(a.olderThan)||o(s,a.olderThan))||!(!k(a.youngerThan)||o(a.youngerThan,s))||!!(k(a.minAdded)&&s.added<a.minAdded)||!!(k(a.maxAdded)&&s.added>a.maxAdded)||(s.reasons.splice(n,1),0!==s.reasons.length||(d(r,s),i.push(s.added),!1))}),this.added=this.added.filter(e=>!i.includes(e[1].added))}async clean(){this.created=[],this.added=[],this.lastReceived=0,this.lastAdded=0,this.lastSent=0}async getLastAdded(){return this.lastAdded}async getLastSynced(){return{received:this.lastReceived,sent:this.lastSent}}async setLastSynced(e){void 0!==e.sent&&(this.lastSent=e.sent),void 0!==e.received&&(this.lastReceived=e.received)}}P={MemoryStore:Q};let m=()=>({events:{},emit(e,...t){for(let s of this.events[e]||[])s(...t)},on(e,t){return(this.events[e]=this.events[e]||[]).push(t),()=>this.events[e]=this.events[e].filter(e=>e!==t)}});var n={};class p extends Error{static describe(r,o){return"timeout"===r?"A timeout was reached ("+o+"ms)":"wrong-format"===r?"Wrong message format in "+o:"unknown-message"===r?"Unknown message `"+o+"` type":"bruteforce"===r?"Too many wrong authentication attempts":"wrong-protocol"===r?"Logux supports protocols only from version "+o.supported+", but you use "+o.used:"wrong-subprotocol"===r?"Only "+o.supported+" application subprotocols are supported, but you use "+o.used:"wrong-credentials"===r?"Wrong credentials":r}constructor(r,o,e){super(r),this.name="LoguxError",this.type=r,this.options=o,this.description=p.describe(r,o),this.received=!!e,e?(this.message="Logux received "+this.type+" error",this.description!==this.type&&(this.message+=" ("+this.description+")")):this.message=this.description,Error.captureStackTrace&&Error.captureStackTrace(this,p)}}n={LoguxError:p};var R={};let{LoguxError:x}=n;async function y(t,e,o,n){if(!t.options.auth)return t.authenticated=!0,void n();try{if(await t.options.auth(o,e)){t.authenticated=!0,n();for(let e=0;e<t.unauthenticated.length;e++)t.onMessage(t.unauthenticated[e]);t.unauthenticated=[]}else t.sendError(new x("wrong-credentials")),t.destroy()}catch(s){"LoguxError"===s.name?(t.sendError(s),t.destroy()):t.error(s)}}function z(t,e){return t.remoteProtocol=e,e>=t.minProtocol||(t.sendError(new x("wrong-protocol",{supported:t.minProtocol,used:e})),t.destroy(),!1)}function A(t){try{t.emitter.emit("connect")}catch(e){if("LoguxError"===e.name)return t.sendError(e),!1;throw e}return!0}function S(){let t=["connect",this.localProtocol,this.localNodeId,this.lastReceived],e={};this.options.credentials&&(e.credentials=this.options.credentials),this.options.subprotocol&&(e.subprotocol=this.options.subprotocol),Object.keys(e).length>0&&t.push(e),this.options.fixTime&&(this.connectSended=this.now()),this.startTimeout(),this.send(t)}function T(t,e){let o=["connected",this.localProtocol,this.localNodeId,[t,e]],n={};this.options.credentials&&(n.credentials=this.options.credentials),this.options.subprotocol&&(n.subprotocol=this.options.subprotocol),Object.keys(n).length>0&&o.push(n),this.send(o)}function U(t,e,o,n){let s=this.now();n||(n={}),this.remoteNodeId=e,z(this,t)&&(this.remoteSubprotocol=n.subprotocol||"0.0.0",A(this)?y(this,e,n.credentials,()=>{this.baseTime=this.now(),this.sendConnected(s,this.baseTime),this.syncSince(o)}):this.destroy())}function V(t,e,o,n){if(n||(n={}),this.endTimeout(),this.remoteNodeId=e,z(this,t)){if(this.baseTime=o[1],this.options.fixTime){let t=this.now(),e=o[1]-o[0],n=t-this.connectSended-e;this.timeFix=Math.floor(this.connectSended-o[0]+n/2)}this.remoteSubprotocol=n.subprotocol||"0.0.0",A(this)?y(this,e,n.credentials,()=>{this.syncSince(this.lastSent)}):this.destroy()}}R={sendConnect:S,sendConnected:T,connectMessage:U,connectedMessage:V};var c,d;function q(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function W(r){if(c===setTimeout)return setTimeout(r,0);if((c===q||!c)&&setTimeout)return c=setTimeout,setTimeout(r,0);try{return c(r,0)}catch($){try{return c.call(null,r,0)}catch($){return c.call(this,r,0)}}}function X(r){if(d===clearTimeout)return clearTimeout(r);if((d===s||!d)&&clearTimeout)return d=clearTimeout,clearTimeout(r);try{return d(r)}catch($){try{return d.call(null,r)}catch($){return d.call(this,r)}}}!function(){try{c="function"==typeof setTimeout?setTimeout:q}catch(r){c=q}try{d="function"==typeof clearTimeout?clearTimeout:s}catch(r){d=s}}();var e,g=[],B=!1,C=-1;function Y(){B&&e&&(B=!1,e.length?g=e.concat(g):C=-1,g.length&&Z())}function Z(){if(!B){var r=W(Y);B=!0;for(var $=g.length;$;){for(e=g,g=[];++C<$;)e&&e[C].run();C=-1,$=g.length}e=null,B=!1,X(r)}}function $(r,$){this.fun=r,this.array=$}$.prototype.run=function(){this.fun.apply(null,this.array)};var _={};function aa(i,e){this.startTimeout();let s=[];for(let[t,n]of e){let i={};for(let e in n)"id"===e?i.id=n.id.split(" "):"added"!==e&&(i[e]=n[e]);this.timeFix&&(i.time-=this.timeFix),i.id[0]=parseInt(i.id[0])-this.baseTime,i.id[2]=parseInt(i.id[2]),i.time-=this.baseTime,i.id[1]===this.localNodeId&&(0===i.id[2]?i.id=i.id[0]:i.id=[i.id[0],i.id[2]]),s.unshift(t,i)}this.syncing+=1,this.setState("sending"),this.send(["sync",i].concat(s))}function ba(i){this.send(["synced",i])}async function ca(i,...e){let s=[];for(let t=0;t<e.length-1;t+=2){let i=e[t],n=e[t+1];"number"==typeof n.id?n.id=n.id+this.baseTime+" "+this.remoteNodeId+" 0":(n.id[0]=n.id[0]+this.baseTime,2===n.id.length?n.id=n.id[0]+" "+this.remoteNodeId+" "+n.id[1]:n.id=n.id.join(" ")),n.time=n.time+this.baseTime,this.timeFix&&(n.time=n.time+this.timeFix);let d=Promise.resolve([i,n]);this.options.inMap&&(d=d.then(([i,e])=>this.options.inMap(i,e)).catch(i=>{this.error(i)})),d.then(i=>i&&this.options.inFilter?this.options.inFilter(...i).then(e=>!!e&&i).catch(i=>{this.error(i)}):i).then(i=>!!i&&(this.received[i[1].id]=!0,this.log.add(i[0],i[1]))),s.push(d)}await Promise.all(s),this.setLastReceived(i),this.sendSynced(i)}function da(i){this.endTimeout(),this.setLastSent(i),this.syncing>0&&(this.syncing-=1),0===this.syncing&&this.setState("synchronized")}_={sendSync:aa,sendSynced:ba,syncMessage:ca,syncedMessage:da};var ea={};function fa(){this.startTimeout(),this.send(["ping",this.lastAddedCache]),this.pingTimeout&&clearTimeout(this.pingTimeout)}function ga(e){this.setLastReceived(e),this.connected&&this.authenticated&&this.send(["pong",this.lastAddedCache])}function ha(e){this.setLastReceived(e),this.endTimeout()}ea={sendPing:fa,pingMessage:ga,pongMessage:ha};var ia={};function ja(e,$){this.send(["debug",e,$])}function ka(e,$){this.emitter.emit("debug",e,$)}ia={sendDebug:ja,debugMessage:ka};var la={};function ma(r){let e=["error",r.type];void 0!==r.options&&e.push(r.options),this.send(e),this.emitter.emit("clientError",r)}function na(r,e){this.syncError(r,e,!0)}la={sendError:ma,errorMessage:na};var oa={};let{sendConnect:pa,sendConnected:qa,connectMessage:ra,connectedMessage:sa}=R,{sendSync:ta,sendSynced:ua,syncMessage:va,syncedMessage:wa}=_,{sendPing:xa,pingMessage:ya,pongMessage:za}=ea,{sendDebug:Aa,debugMessage:Ba}=ia,{sendError:Ca,errorMessage:Da}=la,{LoguxError:D}=n;const Ea={"wrong-subprotocol":!0,"wrong-protocol":!0,timeout:!0},Fa=["connect","connected","error","debug"];async function E(e,t,s){let o=s.added;if(void 0===o){let t=e.lastAddedCache;o=t>e.lastSent?t:e.lastSent}if(e.options.outMap)try{let i=await e.options.outMap(t,s);e.sendSync(o,[i])}catch(n){e.error(n)}else e.sendSync(o,[[t,s]])}class a{constructor(e,t,s,o={}){if(this.remoteNodeId=void 0,this.remoteProtocol=void 0,this.remoteSubprotocol=void 0,this.minProtocol=2,this.localProtocol=2,this.localNodeId=e,this.log=t,this.connection=s,this.options=o,this.options.ping&&!this.options.timeout)throw new Error("You must set timeout option to use ping");this.connected=!1,this.authenticated=!1,this.unauthenticated=[],this.timeFix=0,this.syncing=0,this.received={},this.lastSent=0,this.lastReceived=0,this.state="disconnected",this.emitter=m(),this.timeouts=[],this.throwsError=!0,this.unbind=[],this.unbind.push(t.on("add",(e,t)=>{this.onAdd(e,t)})),this.unbind.push(s.on("connecting",()=>{this.onConnecting()})),this.unbind.push(s.on("connect",()=>{this.onConnect()})),this.unbind.push(s.on("message",e=>{this.onMessage(e)})),this.unbind.push(s.on("error",e=>{"Wrong message format"===e.message?(this.sendError(new D("wrong-format",e.received)),this.connection.disconnect("error")):this.error(e)})),this.unbind.push(s.on("disconnect",()=>{this.onDisconnect()})),this.initialized=!1,this.lastAddedCache=0,this.initializing=this.initialize()}on(e,t){return this.emitter.on(e,t)}catch(e){this.throwsError=!1,this.on("error",e)}waitFor(e){return this.state===e?Promise.resolve():new Promise(t=>{let s=this.on("state",()=>{this.state===e&&(s(),t())})})}destroy(){this.connection.destroy?this.connection.destroy():this.connected&&this.connection.disconnect("destroy");for(let e of this.unbind)e();clearTimeout(this.pingTimeout),this.endTimeout()}send(e){if(this.connected){this.delayPing();try{this.connection.send(e)}catch(t){this.error(t)}}}onConnecting(){this.setState("connecting")}onConnect(){this.delayPing(),this.connected=!0}onDisconnect(){for(;this.timeouts.length>0;)this.endTimeout();this.pingTimeout&&clearTimeout(this.pingTimeout),this.authenticated=!1,this.connected=!1,this.setState("disconnected")}onMessage(e){this.delayPing();let t=e[0];this.authenticated||Fa.includes(t)?this[t+"Message"](...e.slice(1)):this.unauthenticated.push(e)}async onAdd(e,t){if(this.authenticated)if(this.lastAddedCache<t.added&&(this.lastAddedCache=t.added),this.received[t.id])delete this.received[t.id];else if(this.options.outFilter)try{(await this.options.outFilter(e,t))&&E(this,e,t)}catch(s){this.error(s)}else E(this,e,t)}syncError(e,t,s){let o=new D(e,t,s);if(this.emitter.emit("error",o),!Ea[e]&&this.throwsError)throw o}error(e){if(this.emitter.emit("error",e),this.connection.disconnect("error"),this.throwsError)throw e}setState(e){this.state!==e&&(this.state=e,this.emitter.emit("state"))}startTimeout(){if(!this.options.timeout)return;let e=this.options.timeout,t=setTimeout(()=>{this.connected&&this.connection.disconnect("timeout"),this.syncError("timeout",e)},e);this.timeouts.push(t)}endTimeout(){this.timeouts.length>0&&clearTimeout(this.timeouts.shift())}delayPing(){this.options.ping&&(this.pingTimeout&&clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(()=>{this.connected&&this.authenticated&&this.sendPing()},this.options.ping))}async syncSinceQuery(e){let t=[];await this.log.each({order:"added"},(s,o)=>!(o.added<=e)&&(this.options.outFilter?t.push(this.options.outFilter(s,o).then(e=>!!e&&[s,o]).catch(e=>{this.error(e)})):t.push(Promise.resolve([s,o])),!0));let s=await Promise.all(t),o={added:0};return o.entries=s.filter(e=>(e&&o.added<e[1].added&&(o.added=e[1].added),!1!==e)),o}async syncSince(e){let t=await this.syncSinceQuery(e);this.connected&&(t.entries.length>0?this.options.outMap?Promise.all(t.entries.map(e=>this.options.outMap(e[0],e[1]))).then(e=>{this.sendSync(t.added,e)}).catch(e=>{this.error(e)}):this.sendSync(t.added,t.entries):this.setState("synchronized"))}setLastSent(e){this.lastSent<e&&(this.lastSent=e,this.log.store.setLastSynced({sent:e}))}setLastReceived(e){this.lastReceived<e&&(this.lastReceived=e),this.log.store.setLastSynced({received:e})}now(){return Date.now()}async initialize(){let[e,t]=await Promise.all([this.log.store.getLastSynced(),this.log.store.getLastAdded()]);this.initialized=!0,this.lastSent=e.sent,this.lastReceived=e.received,this.lastAddedCache=t,this.connection.connected&&this.onConnect()}sendDuilian(){this.send(["duilian",Object.keys(r)[0]])}duilianMessage(e){r[e]&&this.send(["duilian",r[e]])}}a.prototype.sendConnect=pa,a.prototype.sendConnected=qa,a.prototype.connectMessage=ra,a.prototype.connectedMessage=sa,a.prototype.sendSync=ta,a.prototype.sendSynced=ua,a.prototype.syncMessage=va,a.prototype.syncedMessage=wa,a.prototype.sendPing=xa,a.prototype.pingMessage=ya,a.prototype.pongMessage=za,a.prototype.sendDebug=Aa,a.prototype.debugMessage=Ba,a.prototype.sendError=Ca,a.prototype.errorMessage=Da;const r={"\u91D1\u6728\u6C34\u706B\u571F":"\u677F\u57CE\u70E7\u9505\u9152"};oa={BaseNode:a};var Ga={};let{BaseNode:Ha}=oa;const Ia={fixTime:!0,timeout:2e4,ping:5e3};class Ja extends Ha{constructor(e,s,t,n={}){super(e,s,t,n={...Ia,...n})}onConnect(){this.connected||(this.connected=!0,this.initializing=this.initializing.then(()=>{this.connected&&this.sendConnect()}))}}Ga={ClientNode:Ja};var Ka={};class La{constructor(e={}){if(void 0===e.nodeId)throw new Error("Expected node ID");if("object"!=typeof e.store)throw new Error("Expected store");if(e.nodeId.includes(" "))throw new Error("Space is prohibited in node ID");this.nodeId=e.nodeId,this.lastTime=0,this.sequence=0,this.store=e.store,this.emitter=m()}on(e,t){return this.emitter.on(e,t)}async add(e,t={}){if(void 0===e.type)throw new Error("Expected \"type\" in action");let r=!1;void 0===t.id&&(r=!0,t.id=this.generateId()),void 0===t.time&&(t.time=parseInt(t.id)),void 0===t.reasons?t.reasons=[]:Array.isArray(t.reasons)||(t.reasons=[t.reasons]);for(let s of t.reasons)if("string"!=typeof s)throw new Error("Expected \"reasons\" to be strings");if(this.emitter.emit("preadd",e,t),t.keepLast&&(this.removeReason(t.keepLast,{olderThan:t}),t.reasons.push(t.keepLast)),0===t.reasons.length&&r)return this.emitter.emit("add",e,t),this.emitter.emit("clean",e,t),t;if(0===t.reasons.length){let[r]=await this.store.byId(t.id);return!r&&(this.emitter.emit("add",e,t),this.emitter.emit("clean",e,t),t)}{let r=await this.store.add(e,t);return!1!==r&&(this.emitter.emit("add",e,r),r)}}generateId(){let e=Date.now();return e<=this.lastTime?(e=this.lastTime,this.sequence+=1):(this.lastTime=e,this.sequence=0),e+" "+this.nodeId+" "+this.sequence}each(e,t){t||(t=e,e={order:"created"});let r=this.store;return new Promise(s=>{!async function e(r){let i,n=await r();for(let s=n.entries.length-1;s>=0;s--){let e=n.entries[s];if(!1===(i=t(e[0],e[1])))break}!1!==i&&n.next?e(n.next):s()}(r.get.bind(r,e))})}async changeMeta(e,t){for(let r in t)if("id"===r||"added"===r||"time"===r||"subprotocol"===r)throw new Error("Meta \""+r+"\" is read-only");if(t.reasons&&0===t.reasons.length){let r=await this.store.remove(e);if(r){for(let e in t)r[1][e]=t[e];this.emitter.emit("clean",r[0],r[1])}return!!r}return this.store.changeMeta(e,t)}removeReason(e,t={}){return this.store.removeReason(e,t,(e,t)=>{this.emitter.emit("clean",e,t)})}byId(e){return this.store.byId(e)}}Ka={Log:La};var Ma={};class Na{constructor(e,t,r){if(this.connected=!1,this.emitter=m(),t)this.WS=t;else{if("undefined"==typeof WebSocket)throw new Error("No WebSocket support");this.WS=WebSocket}this.url=e,this.opts=r}init(e){e.onerror=e=>{this.emitter.emit("error",e.error||new Error("WS Error"))},e.onclose=()=>{this.ws&&(this.connected=!1,this.emitter.emit("disconnect"))},e.onmessage=e=>{let t;try{t=JSON.parse(e.data)}catch(r){return void this.error(e.data)}this.emitter.emit("message",t)},this.ws=e}connect(){return this.emitter.emit("connecting"),this.init(new this.WS(this.url,void 0,this.opts)),new Promise(e=>{this.ws.onopen=()=>{this.connected=!0,this.emitter.emit("connect"),e()}})}disconnect(){this.ws&&(this.ws.onclose(),this.ws.close(),this.ws=void 0)}on(e,t){return this.emitter.on(e,t)}send(e){this.ws&&this.ws.readyState===this.ws.OPEN?this.ws.send(JSON.stringify(e)):this.emitter.emit("error",new Error("WS was closed"))}error(e){let t=new Error("Wrong message format");t.received=e,this.emitter.emit("error",t)}}Ma={WsConnection:Na};var Oa={};const Pa={minDelay:1e3,maxDelay:5e3,attempts:1/0},Qa=["wrong-protocol","wrong-subprotocol","wrong-credentials"];class Ra{constructor(n,t={}){this.connection=n,this.options={...Pa,...t},this.reconnecting=n.connected,this.connecting=!1,this.attempts=0,this.unbind=[],this.unbind.push(this.connection.on("message",n=>{"error"===n[0]&&Qa.includes(n[1])&&(this.reconnecting=!1)})),this.unbind.push(this.connection.on("connecting",()=>{this.connecting=!0})),this.unbind.push(this.connection.on("connect",()=>{this.attempts=0,this.connecting=!1})),this.unbind.push(this.connection.on("disconnect",()=>{this.connecting=!1,this.reconnecting&&this.reconnect()})),this.unbind.push(()=>{clearTimeout(this.timer)});let e=()=>{!this.reconnecting||this.connected||this.connecting||"undefined"==typeof document||document.hidden||this.connect()},i=()=>{!this.reconnecting||this.connected||this.connecting||navigator.onLine&&this.connect()},o=()=>{this.disconnect("freeze")};"undefined"!=typeof document&&"undefined"!=typeof window&&document.addEventListener&&window.addEventListener&&(document.addEventListener("visibilitychange",e,!1),window.addEventListener("focus",i,!1),window.addEventListener("online",i,!1),window.addEventListener("resume",i,!1),window.addEventListener("freeze",o,!1),this.unbind.push(()=>{document.removeEventListener("visibilitychange",e,!1),window.removeEventListener("focus",i,!1),window.removeEventListener("online",i,!1),window.removeEventListener("resume",i,!1),window.removeEventListener("freeze",o,!1)}))}connect(){return this.attempts+=1,this.reconnecting=!0,this.connection.connect()}disconnect(n){return"timeout"!==n&&"error"!==n&&"freeze"!==n&&(this.reconnecting=!1),this.connection.disconnect(n)}destroy(){for(let n of this.unbind)n();this.disconnect("destroy")}reconnect(){if(this.attempts>this.options.attempts-1)return this.reconnecting=!1,void(this.attempts=0);let n=this.nextDelay();this.timer=setTimeout(()=>{!this.reconnecting||this.connecting||this.connected||this.connect()},n)}send(...n){return this.connection.send(...n)}on(...n){return this.connection.on(...n)}nextDelay(){let n=this.options.minDelay*2**this.attempts,t=Math.random(),e=Math.floor(.5*t*n);return 1===Math.floor(10*t)&&(e=-e),Math.min(n+e,this.options.maxDelay)||0}get connected(){return this.connection.connected}}Oa={Reconnect:Ra};var u={};for(var Sa=self.crypto||self.msCrypto,Ta="-_",f=36;f--;)Ta+=f.toString(36);for(f=36;f-- -10;)Ta+=f.toString(36).toUpperCase();u=function($){var r="",e=Sa.getRandomValues(new Uint8Array($||21));for(f=$||21;f--;)r+=Ta[63&e[f]];return r};var Ua={};let{isFirstOlder:F}=t,{WsConnection:Va}=Ma,{MemoryStore:Wa}=P,{ClientNode:Xa}=Ga,{Reconnect:Ya}=Oa,{Log:Za}=Ka;function G(t){localStorage.setItem(t.options.prefix+":tab:"+t.tabId,Date.now())}function H(t,e){t.log.removeReason("tab"+e).then(()=>{t.isLocalStorage&&localStorage.removeItem(t.options.prefix+":tab:"+e)})}let $a=["id","time","channels"];class _a{constructor(t={}){if(this.options=t,void 0===this.options.prefix&&(this.options.prefix="logux"),this.isLocalStorage=!1,"undefined"!=typeof localStorage){let t=u();try{localStorage.setItem(t,"1"),localStorage.removeItem(t),this.isLocalStorage=!0}catch(c){}}let e;this.options.userId?this.options.userId=this.options.userId.toString():this.options.userId="false",this.options.time?(this.tabId=this.options.time.lastId+1+"",this.clientId=this.options.userId+":"+this.tabId):(this.clientId=this.options.userId+":"+this.getClientId(),this.tabId=u(8)),this.nodeId=this.clientId+":"+this.tabId,/^ws:\/\//.test(this.options.server)&&!t.allowDangerousProtocol&&(e=async t=>"object"==typeof t&&"development"===t.env||(console.error("Without SSL, old proxies block WebSockets. Use WSS for Logux or set allowDangerousProtocol option."),!1));let o,i=this.options.store||new Wa;o=this.options.time?this.options.time.nextLog({store:i,nodeId:this.nodeId}):new Za({store:i,nodeId:this.nodeId}),this.log=o,o.on("preadd",(t,e)=>{e.id.includes(" ".concat(this.nodeId," "))&&!e.subprotocol&&(e.subprotocol=this.options.subprotocol),e.sync&&!e.resubscribe&&e.reasons.push("syncing")}),this.last={},this.subscriptions={};let s={},n={};this.emitter=m(),this.on("add",(t,e)=>{let o,i,r=t.type;if("logux/processed"!==r&&"logux/undo"!==r||this.log.removeReason("syncing",{id:t.id}),"logux/subscribe"!==r||e.resubscribe){if("logux/unsubscribe"===r)n[e.id]=t;else if("logux/processed"===r&&n[t.id]){let e=n[t.id];o=JSON.stringify({...e,type:"logux/subscribe"});let i=this.subscriptions[o];i&&(1===i?delete this.subscriptions[o]:this.subscriptions[o]=i-1)}else if("logux/processed"===r&&s[t.id]){let n=s[t.id];delete s[t.id],o=JSON.stringify(n),this.subscriptions[o]?this.subscriptions[o]+=1:this.subscriptions[o]=1,(i=this.last[n.channel])&&!F(i,e)||(this.last[n.channel]={id:e.id,time:e.time})}else"logux/undo"===r?(delete s[t.id],delete n[t.id]):e.channels&&(e.id.includes(" "+this.clientId+":")||e.channels.forEach(t=>{(i=this.last[t])&&!F(i,e)||(this.last[t]={id:e.id,time:e.time})}));}else s[e.id]=t}),this.tabPing=6e4,this.tabTimeout=10*this.tabPing;let r,l="tab"+this.tabId;if(this.isLocalStorage){let t=o.on("add",(e,o)=>{o.reasons.includes(l)&&(G(this),this.pinging=setInterval(()=>{G(this)},this.tabPing),t())})}if("string"==typeof this.options.server){let t=new Va(this.options.server);r=new Ya(t,{minDelay:this.options.minDelay,maxDelay:this.options.maxDelay,attempts:this.options.attempts})}else r=this.options.server;this.node=new Xa(this.nodeId,this.log,r,{credentials:this.options.credentials,subprotocol:this.options.subprotocol,outFilter:async(t,e)=>{let o=e.id.split(" ")[1].replace(/:.*$/,"");return!!e.sync&&o===this.options.userId},timeout:this.options.timeout,outMap:async(t,e)=>{let o={};for(let i in e)$a.includes(i)&&(o[i]=e[i]),e.subprotocol&&e.subprotocol!==this.options.subprotocol&&(o.subprotocol=e.subprotocol);return[t,o]},ping:this.options.ping,auth:e}),this.node.on("debug",(t,e)=>{"error"===t&&console.error("Error on Logux server:\n",e)});let a=!0;this.node.on("state",()=>{let t=this.node.state;if("synchronized"===t||"sending"===t){if(a){a=!1;for(let t in this.subscriptions){let e=JSON.parse(t),o=this.last[e.channel];o&&(e.since=o),this.log.add(e,{sync:!0,resubscribe:!0})}}}else"disconnected"===this.node.state&&(a=!0)}),this.onUnload=this.onUnload.bind(this),"undefined"!=typeof window&&window.addEventListener&&window.addEventListener("unload",this.onUnload)}start(){this.cleanPrevActions(),this.node.connection.connect()}on(t,e){return this.log.emitter.on(t,e)}destroy(){this.onUnload(),this.node.destroy(),clearInterval(this.pinging),"undefined"!=typeof window&&window.removeEventListener&&window.removeEventListener("unload",this.onUnload)}clean(){return this.destroy(),this.log.store.clean?this.log.store.clean():Promise.resolve()}cleanPrevActions(){if(this.isLocalStorage)for(let t in localStorage){let e=this.options.prefix+":tab:";if(t.slice(0,e.length)===e){let o=parseInt(localStorage.getItem(t));Date.now()-o>this.tabTimeout&&H(this,t.slice(e.length))}}}onUnload(){this.pinging&&H(this,this.tabId)}getClientId(){return u(8)}}Ua={Client:_a};let{LoguxError:ab}=n,{Client:bb}=Ua;function b(e,t){return e.options.prefix+":"+e.options.userId+":"+t}function i(e,t,r){if(!e.isLocalStorage)return;let a=b(e,t),o=JSON.stringify(r);try{localStorage.setItem(a,o)}catch(i){console.error(i),e.isLocalStorage=!1,e.role="leader",e.emitter.emit("role"),e.node.connection.connect()}}function I(e){let t=localStorage.getItem(b(e,"leader")),r=[];return"string"==typeof t&&(r=JSON.parse(t)),r}function J(e){i(e,"leader",[e.tabId,Date.now()])}function K(e){"disconnected"!==e.state&&N(e,"disconnected"),M(e)}function l(e){clearTimeout(e.watching),e.watching=setTimeout(()=>{L(e)?l(e):K(e)},e.roleTimeout)}function cb(e,t){if(!t.subprotocol)return!1;if(e.options.subprotocol===t.subprotocol)return!1;let r=t.id.split(" ")[1],a=e.clientId+":";if(r.slice(0,a.length)!==a)return!1;let o=e.options.subprotocol.split("."),i=t.subprotocol.split(".");for(let s=0;s<o.length;s++){let e=parseInt(o[s]),t=parseInt(i[s]);if(e>t)return!1;if(e<t)return!0}return!1}function h(e,t){if(e.role!==t){let r=e.node;if(e.role=t,clearTimeout(e.watching),"leader"===t?(localStorage.removeItem(b(e,"state")),e.leadership=setInterval(()=>{e.unloading||J(e)},e.leaderPing),r.connection.connect()):(clearTimeout(e.elections),clearInterval(e.leadership),"disconnected"!==r.state&&e.node.connection.disconnect()),"follower"===t){let t="disconnected",r=localStorage.getItem(b(e,"state"));r&&null!==r&&(t=JSON.parse(r)),t!==e.state&&(e.state=t,e.emitter.emit("state"))}e.emitter.emit("role")}}function L(e){let t=I(e);return t[1]&&t[1]>=Date.now()-e.leaderTimeout}function M(e){J(e),h(e,"candidate"),e.elections=setTimeout(()=>{I(e,"leader")[0]===e.tabId?h(e,"leader"):(h(e,"follower"),l(e))},e.electionDelay)}function N(e,t){e.state=t,e.emitter.emit("state"),i(e,"state",e.state)}function db(e){return e.created&&e.added}class gb extends bb{constructor(e={}){super(e),this.role="candidate",this.roleTimeout=3e3+Math.floor(1e3*Math.random()),this.leaderTimeout=5e3,this.leaderPing=2e3,this.electionDelay=1e3,this.state=this.node.state,this.node.on("state",()=>{"leader"===this.role&&N(this,this.node.state)}),this.log.on("add",(e,t)=>{this.emitter.emit("add",e,t),t.tab!==this.tabId&&i(this,"add",[this.tabId,e,t])}),this.log.on("clean",(e,t)=>{this.emitter.emit("clean",e,t)}),"undefined"!=typeof window&&window.addEventListener&&(window.addEventListener("storage",e=>this.onStorage(e)),window.addEventListener("unload",e=>this.onUnload(e)))}start(){if(this.cleanPrevActions(),!this.isLocalStorage)return this.role="leader",this.emitter.emit("role"),void this.node.connection.connect();L(this)?(h(this,"follower"),l(this)):M(this)}destroy(){super.destroy(),clearTimeout(this.watching),clearTimeout(this.elections),clearInterval(this.leadership),"undefined"!=typeof window&&window.removeEventListener&&window.removeEventListener("storage",this.onStorage)}clean(){return this.isLocalStorage&&(localStorage.removeItem(b(this,"add")),localStorage.removeItem(b(this,"state")),localStorage.removeItem(b(this,"client")),localStorage.removeItem(b(this,"leader"))),super.clean()}on(e,t){return"preadd"===e?this.log.emitter.on(e,t):this.emitter.on(e,t)}onStorage(e){if(null===e.newValue)return;let t;if(e.key===b(this,"add")){if((t=JSON.parse(e.newValue))[0]!==this.tabId){let e=t[1],r=t[2];if(cb(this,r)){let e=new ab("wrong-subprotocol",{supported:r.subprotocol,used:this.node.options.subprotocol},!0);this.node.emitter.emit("error",e)}r.tab&&r.tab!==this.tabId||(db(this.log.store)&&this.log.store.add(e,r),this.emitter.emit("add",e,r),"leader"===this.role&&this.node.onAdd(e,r))}}else if(e.key===b(this,"leader"))0===(t=JSON.parse(e.newValue)).length?K(this):t[0]!==this.tabId&&"candidate"!==this.role&&(h(this,"follower"),l(this));else if(e.key===b(this,"state")){let t=JSON.parse(localStorage.getItem(e.key));this.state!==t&&(this.state=t,this.emitter.emit("state"))}}onUnload(){"leader"===this.role&&(this.unloading=!0,i(this,"leader",[])),super.onUnload()}getClientId(){let e=b(this,"client");if(this.isLocalStorage){if(localStorage.getItem(e))return localStorage.getItem(e);{let t=super.getClientId();return localStorage.setItem(e,t),t}}return super.getClientId()}get connected(){return"disconnected"!==this.state&&"connecting"!==this.state}}var eb={};function fb(e,t,o={}){let r,n=e.on?e:e.node,s="disconnected"===n.state,d=!1,i=!1;void 0===o.duration&&(o.duration=3e3);let c=[],a={},u=()=>{0===Object.keys(a).length&&(d?(d=!1,t("synchronizedAfterWait"),r=setTimeout(()=>{t("synchronized")},o.duration)):t("synchronized"))};c.push(n.on("state",()=>{clearTimeout(r),i||("disconnected"===n.state?(s=!0,t(d?"wait":"disconnected")):"synchronized"===n.state?(s=!1,u()):"connecting"===n.state?r=setTimeout(()=>{t("connecting"+(d?"AfterWait":""))},100):t(e.state+(d?"AfterWait":"")))})),c.push(e.node.on("error",e=>{"wrong-protocol"===e.type||"wrong-subprotocol"===e.type?(i=!0,t("protocolError")):"timeout"!==e.type&&t("syncError",{error:e})})),c.push(e.node.on("clientError",e=>{t("syncError",{error:e})}));let l=e.on?e:e.log;return c.push(l.on("add",(e,o)=>{"logux/subscribe"!==e.type&&"logux/unsubscribe"!==e.type&&("logux/processed"===e.type?(delete a[e.id],u()):"logux/undo"===e.type?delete a[e.id]:o.sync&&(a[o.id]=!0),"logux/undo"===e.type&&e.reason?"denied"===e.reason?t("denied",{action:e,meta:o}):t("error",{action:e,meta:o}):s&&o.sync&&o.added&&(d||t("wait"),d=!0))})),()=>{for(let e of c)e()}}eb={status:fb};let{status:hb}=eb;})();